{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "React Redux AWS Serverless Starter Pipeline",
    "Parameters": {
        "AppName": {
            "Type": "String",
            "Description": "Name of the application.",
            "MinLength": "1",
            "MaxLength": "80",
            "AllowedPattern": "[A-Za-z0-9-]+",
            "ConstraintDescription": "AppName must only contain upper and lower case letters, numbers, and -."
        }
    },
    "Resources": {
        "S3WebsiteBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "PublicRead",
                "BucketName": {
                    "Fn::Sub": "website-${AppName}-s3-${AWS::Region}"
                },
                "WebsiteConfiguration": { "IndexDocument": "index.html" }
            }
        },
        "S3WebsiteBucketPolicy": {
            "DependsOn": [
                "S3WebsiteBucket"
            ],
            "Description": "Setting Amazon S3 bucket policy for external and AWS CodePipeline access",
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "S3WebsiteBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Id": "SSEAndSSLPolicy",
                    "Statement": [
                        {
                            "Action": [
                                "s3:GetObject"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${S3WebsiteBucket}/*"
                            },
                            "Principal": "*"
                        }
                    ]
                }
            }
        },
        "S3BuildBucket": {
            "Description": "Creating Amazon S3 bucket for AWS CodePipeline build",
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "build-${AppName}-s3-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                }
            }
        },
        "S3BuildBucketPolicy": {
            "DependsOn": [
                "S3BuildBucket"
            ],
            "Description": "Setting Amazon S3 bucket policy for AWS CodePipeline access",
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "S3BuildBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Id": "SSEAndSSLPolicy",
                    "Statement": [
                        {
                            "Sid": "DenyInsecureConnections",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${S3BuildBucket}/*"
                            },
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CodeBuildProject": {
            "Name": {
                "Fn::Sub": "${AppName}-build"
            },            
            "DependsOn": [
                "S3BuildBucket",
                "CodeBuildTrustRole"
            ],
            "Description": "Creating AWS CodeBuild project",
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Artifacts": {
                    "Type": "CODEPIPELINE"
                },
                "Description": {
                    "Fn::Sub": "Building stage for ${AppName}."
                },
                "Environment": {
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "EnvironmentVariables": [
                        {
                            "Name": "S3_ARTIFACT_BUCKET",
                            "Value": {
                                "Ref": "S3BuildBucket"
                            }
                        },
                        {
                            "Name": "S3_WEBSITE_BUCKET",
                            "Value": {
                                "Ref": "S3WebsiteBucket"
                            }
                        },
                        {
                            "Name": "INPUT_FILE",
                            "Value": {
                                "Ref": "SAMInputFile"
                            }
                        }
                    ],
                    "Image": {
                        "Ref": "CodeBuildImage"
                    },
                    "Type": "LINUX_CONTAINER"
                },
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "CodeBuildTrustRole",
                        "Arn"
                    ]
                },
                "Source": {
                    "Type": "CODEPIPELINE"
                },
                "Tags": [
                    {
                        "Key": "app-name",
                        "Value": {
                            "Ref": "AppName"
                        }
                    }
                ],
                "TimeoutInMinutes": 5
            }
        }
    },
    "Outputs": {
        "BucketName": {
            "Value": { "Ref": "S3WebsiteBucket" },
            "Description": "The created bucket name"
        },
        "OriginURL": {
            "Value": {
                "Fn::GetAtt": [
                    "S3WebsiteBucket",
                    "WebsiteURL"
                ]
            },
            "Description": "URL for the website hosted on S3"
        }
    }
}